<!DOCTYPE html>
<html>
<head>
  <title>Logcat viewer</title>
  <script src="https://unpkg.com/vue"></script>
</head>
<body>
  <div id="app">
    <div class="topForm">
      <div class="topFormCol">
        <label for="query">Query:</label>
        <input v-model="query" class="queryBoxInput">
      </div>
      <div class="topFormCol">
        <input type="checkbox" @click="onPauseClicked" v-model="isPaused">
        <label for="checkbox">Pause</label>
      </div>
      <div class="topFormCol">
        <div class="topFormCol">
          <label for="saveListName">Save as</label>
          <input id="saveListName" v-model="savedListName">
        </div>
        <div class="topFormCol">
          <button id="saveListButton" @click="saveList">
          <label for="saveListButton">Save</label>
        </div>
      </div>
      <template v-if="loadedList">
        <div class="topFormCol">
          <button id="closeLoadedListButton" @click="closeLoadedList">
          <label for="closeLoadedListButton">Close LoadedList</label>
        </div>
      </template>
      <template v-if="Object.keys(savedLists).length > 0">
        <div class="topFormCol">
          <button id="clearSavedListsButton" @click="clearSavedLists">
          <label for="clearSavedListsButton">Clear Saved Lists</label>
        </div>
      </template>
    </div>
    <div class="main">
      <div class="col">
        <table>
        <thead>
          <tr>
            <th>
              Time
            </th>
            <th>
              Thread
            </th>
            <th>
              Tag
            </th>
            <th>
              Message
            </th>
            <th>
              Stack?
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-bind:class="{ selected: (line === selected) }" v-on:click="selectLine(line)" v-for="line in linesComputed">
            <td style="width: 50px">
              {{ line.date.substr(11, 19) }}
            </td>
            <td style="width: 50px; max-width: 50px">
              {{ line.tid }}
            </td>
            <td style="width: 150px; max-width: 150px">
              {{ line.tag }}
            </td>
            <td style="width: 300px; max-width: 300px">
              {{ line.message}}
            </td>
            <td style="width: 20px; max-width: 20px">
              {{ line.stack !== undefined }}
            </td>
          </tr>
        </tbody>
        </table>
        </div>
        <template  v-if="selected">
          <div class="savedListsContainer">
            <div class="">
              Saved lists:
            </div>
            <div>
              <div v-for="(list, name) in savedLists" class="sideRow">
                <div class="savedLists">
                  <div @click="openList(list)" class="sideLabel">
                    {{ name }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
      <div v-if="selected !== undefined" class="col logView">
        <div class="sideRow">
          <div class="sideLabel">
            Time:
          </div>
          <div class="sideContent">
            <p id="time">{{ selected.date }}</p>
          </div>
        </div>
        <div class="sideRow">
          <div class="sideLabel">
            Tag:
          </div>
          <div class="sideContent">
            <p id="time">{{ selected.tag }}</p>
          </div>
        </div>
        <div class="sideRow">
          <div class="sideLabel">
            Message:
          </div>
          <div class="sideContent">
            <p id="time">{{ selected.message }}</p>
          </div>
        </div>
        <template  v-if="selected.formattedStack">
          <div class="exceptionBox">
            <div class="sideLabel">
              Stack:
            </div>
            <div class="sideContent exceptionText">
              <div v-for="stackLine in selected.formattedStack">
                <a target="_blank" v-bind:href="stackLine.link">{{ stackLine.text }}</a>
              </div>
            </div>
          </div>
        </template>
      </div>
  </div>

  <script>
    function getModuleUrl(path) {
      const moduleUrls = {
        android: {
          app: 'https://github.sc-corp.net/Snapchat/android/blob/master/snapchat/app/src/main/java',
        },
        map: 'https://github.sc-corp.net/Snapchat/android/blob/master/snapchat/map/src/main/java',
      }
      let module = path.split('.');

      let i = 2;
      let halfPath = moduleUrls;
      while (true) {
        if (typeof halfPath === 'string') {
          return halfPath;
        }
        if (!halfPath) {
          return null;
        }
        halfPath = halfPath[module[i]];
        i++;
      }
    }

    function formatStack(stack) {
      const lines = stack.split('\n').slice(2);

      return lines.map((line) => {
        const regEx = /(com\.snapchat\.[\w\d\.]+)(\$[\w\d\.]+)?\([\w\d]+\.([\w\d]+):(\d+)\)/g;
        const matches = regEx.exec(line);
        if (!matches) {
          return {text: line};
        }

        let path = matches[1];
        const moduleUrl = getModuleUrl(path);
        if (!matches[2]) { // Has no $runnablepath in the string so remove the function name
          path = path.substr(0, path.lastIndexOf('.'));
        }
        path = path.replace(/\./g, '/');

        const lineNumber = matches[4];
        const fileExtension = matches[3];
        const link = moduleUrl && `${moduleUrl}/${path}.${fileExtension}#L${lineNumber}`;
        return {text: line, link: link};
      });
    }

    let lines = {data: [], isPaused: false};
    let cleared = [];
    let savedLists = localStorage.getItem('savedLists');
    if (!savedLists) {
      savedLists = {};
    } else {
      try {
        savedLists = JSON.parse(savedLists);
      } catch (e) {
        savedLists = {};
      }
    }

    var app = new Vue({
      el: '#app',
      data: {
        lines: lines,
        query: '',
        cleared: cleared,
        selected: {},
        isPaused: false,
        savedLists: savedLists,
        savedListName: '',
        loadedList: null,
      },
      methods: {
        selectLine(line) {
          this.selected = line;
          this.selected.formattedStack = line.stack && formatStack(line.stack);
        },
        onPauseClicked() {
          this.isPaused = !this.isPaused;
          this.lines.isPaused = this.isPaused;
        },
        openList(list) {
          this.loadedList = list;
        },
        closeLoadedList() {
          this.loadedList = null;
        },
        clearSavedLists() {
          this.savedLists = {};
          localStorage.setItem('savedLists', "{}");
        },
        saveList() {
          const name = this.savedListName;
          this.savedLists[name] = this.linesComputed;
          const str = JSON.stringify(this.savedLists);
          localStorage.setItem('savedLists', str);
          this.$forceUpdate();
        }
      },
      computed: {
        linesComputed() {
          var self = this;
          let list = self.lines.data;
          if (self.loadedList) {
            list = self.loadedList;
          }
          const filtered = list.filter(function(line) {
            if (!line.message) {
              return false;
            }
            const iMessage = line.message.toLowerCase();
            const iTag = line.tag.toLowerCase();
            const iQuery = self.query.toLowerCase();
            return iMessage.search(iQuery) > -1 || iTag.search(iQuery) > -1
          });

          return filtered.slice(-1000).reverse();
        },
      },
    })

    window.WebSocket = window.WebSocket || window.MozWebSocket;

    var connection = new WebSocket('ws://127.0.0.1:3000');

    connection.onopen = function () {
      // connection is opened and ready to use
    };

    connection.onerror = function (error) {
      // an error occurred when sending/receiving data
    };

    connection.onmessage = function (message) {
      if (lines.isPaused) {
        return;
      }

      if (lines.data.length > 50000) {
        lines.data = lines.slice(-10000);
        cleared.push(true);
      }
      try {
        var json = JSON.parse(message.data);
        lines.data.push.apply(lines.data, json);
      } catch (e) {
        console.log('This doesn\'t look like a valid JSON: ',
            message.data);
        return;
      }
    };
  </script>

  <style type="text/css">
    .topForm {
      align-items: center;
      display: flex;
      flex-direction: row;
      border: 2px solid #42b983;
      border-radius: 3px;
      background-color: #fff;
      padding: 8px;
    }

    .topFormCol {
      padding: 0 10px;
      display: flex;
      flex-direction: row;
      border: 1px solid #eee;
      border-top: 0;
      border-bottom: 0;
    }

    #app {
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    body {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .main {
      display: flex;
      align-items: stretch;
    }

    .savedListsContainer {
      border: 2px solid #42b983;
      border-radius: 3px;
      background-color: #fff;
      padding: 8px;
      width: 100%;
    }

    .col {
      border: 1px;
      flex: 1;
      width: 850;
    }

    .queryBoxContainer {
      border: 1px;
      margin-bottom: 20px;
    }

    table {
      border: 2px solid #42b983;
      border-radius: 3px;
      background-color: #fff;
    }

    thead {
      display: block;
    }

    tbody {
      display: block;
      height: 800px;
      overflow-y: scroll;
    }

    th {
      background-color: #42b983;
      color: rgba(255,255,255,0.66);
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    td {
      background-color: #f9f9f9;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th, td {
      padding: 4px 4px;
    }

    .sideContainer {
      display: flex;
      flex-direction: column;
    }

    .logView {
      max-height: 400px;
      width: 800px;
      overflow-y: scroll;
      border: 2px solid #42b983;
      border-radius: 3px;
      background-color: #fff;
      display: block;
      font-size: 12px;
    }

    .sideRow {
      border: 1px solid #42b983;
      display: flex;
      flex-direction: row;
      padding: 5px;
    }

    .sideLabel {
      width: 100px;
    }

    .sideContent {
    }

    .exceptionBox {
      padding: 10px;
    }
    .exceptionText {
      font-size: 10px;
    }

    .flex-outer li,
    .flex-inner {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      border-radius: 3px;
    }

    .flex-outer > li > label,
    .flex-outer li p {
      flex: 1 0 120px;
      margin-left: 10px;
      max-width: 100px;
    }

    .selected > td {
      background: #ccc;
    }

    .flex-outer > li > label + *,
    .flex-inner {
      flex: 1 0 100px;
    }
  </style>
</body>
</html>
